<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>任务添加</title>
    <style>
        form {
            margin: 20px auto;
            width: 600px;
            border: 1px solid #ccc;
            padding: 20px
        }
        .targets-container {
            margin-top: 15px;
            border: 1px solid #eee;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .target-item {
            margin: 5px 0;
            padding: 5px;
            background: #f5f5f5;
        }
    </style>
</head>
<body>
<form method="post" action="../add/">
    {% csrf_token %}
    <table>
        <tr>
            <th>开始时间</th>
            <td><input name="student_name"></td>
        </tr>
        <tr>
            <th>结束时间</th>
            <td><input name="student_no"/></td>
        </tr>
        <tr>
            <th>prometheus.yml配置</th>
            <td>
                <textarea name="prometheusyml_node" rows="5" style="width:100%"></textarea>
                <button type="button" id="parse-btn" style="margin-top:5px">解析Targets</button>
                <div class="targets-container" id="targets-container">
                    <!-- 解析后的targets将显示在这里 -->
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <input type="submit"/>
            </td>
        </tr>
    </table>
</form>

<script>
document.getElementById('parse-btn').addEventListener('click', function() {
    const yamlContent = document.getElementsByName('prometheusyml_node')[0].value;
    if (!yamlContent.trim()) {
        alert('请输入prometheus.yml配置内容');
        return;
    }

    // 发送AJAX请求到后端解析
    fetch('/sims/parse_targets/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'yaml_content=' + encodeURIComponent(yamlContent)
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('targets-container');
        container.innerHTML = '';

        if (data.error) {
            container.innerHTML = `<div style="color:red">${data.error}</div>`;
            return;
        }

        if (data.targets && data.targets.length > 0) {
            data.targets.forEach(target => {
                const div = document.createElement('div');
                div.className = 'target-item';
                div.textContent = target;
                container.appendChild(div);
            });
        } else {
            container.innerHTML = '<div>未找到有效的targets</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
});
</script>
</body>
</html>